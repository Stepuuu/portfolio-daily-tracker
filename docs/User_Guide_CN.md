# 中文使用指南

## 目录
1. [简介](#简介)
2. [环境准备](#环境准备)
3. [安装步骤](#安装步骤)
4. [工作原理](#工作原理)
5. [配置说明](#配置说明)
6. [使用方法](#使用方法)
7. [自动化设置](#自动化设置)
8. [常见问题](#常见问题)

---

## 简介

投资组合自动化工具是一个基于 Google Sheets 和 Google Apps Script 的自动化工具，专为需要每日追踪投资组合的用户设计。

### 核心功能

| 功能 | 说明 |
|------|------|
| 📸 **每日快照生成** | 自动复制模板并生成带日期的每日文件 |
| 📈 **混合股价更新** | A股使用新浪接口，境外股票使用 Google Finance |
| 📊 **历史趋势图** | 自动增量更新资产变化趋势图表 |
| 📅 **月度收益日历** | 计算每日盈亏，生成月度汇总表格 |
| 🔍 **智能休市检测** | 检测到休市时自动删除当日文件，避免重复数据 |

---

## 环境准备

### 必需条件
- ✅ 一个 Google 账号
- ✅ 可以访问 Google Drive 和 Google Sheets
- ✅ 稳定的网络连接（用于获取股价）

### 推荐
- 💻 使用 Chrome 浏览器以获得最佳体验
- 📱 或安装 Google Sheets 移动应用

---

## 安装步骤

### 第一步：准备 Google Drive 文件夹

1. 打开 [Google Drive](https://drive.google.com/)
2. 创建一个新文件夹（如：`投资组合记录`）
3. **记录文件夹 ID**：
   - 打开文件夹，查看浏览器地址栏
   - URL 格式为：`https://drive.google.com/drive/folders/XXXXXXXXXXXXXX`
   - `XXXXXXXXXXXXXX` 就是你的文件夹 ID

### 第二步：上传模板文件

1. 下载本项目中的 `template/模板.xlsx`
2. 上传到刚才创建的 Google Drive 文件夹中
3. **不要重命名模板文件**，保持名称为 `模板`

### 第三步：设置 Apps Script

1. 用 Google Sheets 打开上传的 `模板` 文件
2. 点击菜单栏的 `扩展程序` → `Apps Script`
3. 删除编辑器中默认的代码
4. 复制本项目 `src/code.gs` 中的全部代码
5. 粘贴到 Apps Script 编辑器中

### 第四步：修改配置

找到代码开头的 `CONFIG` 配置块，修改以下内容：

```javascript
const CONFIG = {
  TARGET_FOLDER_ID: "xxxxxxxxxxx", // 替换为你的文件夹ID
  // ... 其他配置保持默认即可
};
```

### 第五步：保存并授权

1. 点击 💾 保存按钮（或按 Ctrl+S）
2. 给项目命名（例如：`投资组合自动化`）
3. 刷新 Google Sheets 页面
4. 首次运行时，按照提示完成授权

---

## 工作原理

### 整体流程

```
【一键执行】每日更新全流程
    │
    ├── 1. 创建/替换当日文件
    │      └── 复制模板，命名为 "投资组合记录-YYYYMMDD"
    │
    ├── 2. 更新股价
    │      ├── A股 (SHA/SHE) → 新浪财经接口
    │      └── 其他 → Google Finance
    │
    ├── 3. 等待公式计算（15秒）
    │
    ├── 4. 休市检测
    │      ├── 资产无变化 → 删除文件并退出
    │      └── 资产有变化 → 继续执行
    │
    ├── 5. 更新历史趋势图
    │      └── 增量追加今日数据点
    │
    └── 6. 更新月度收益日历
           └── 计算当日盈亏，更新月度汇总
```

### 股价获取机制

| 交易所代码 | 数据源 | 示例 |
|-----------|--------|------|
| SHA (上海) | 新浪财经 | SHA:600519 |
| SHE (深圳) | 新浪财经 | SHE:000001 |
| 其他 | Google Finance | NASDAQ:AAPL |

### 数据存储结构

每个每日文件包含：
- **Sheet1** - 主持仓表格（资产总和在 H21，成本在 I21）
- **资产图表-源数据** - 历史趋势数据（隐藏工作表）

---

## 配置说明

### CONFIG 配置项详解

```javascript
const CONFIG = {
  // --- 文件与文件夹配置 ---
  TARGET_FOLDER_ID: "xxxxxxxxxxx",     // Google Drive 文件夹 ID
  TEMPLATE_NAME: "模板",                // 模板文件名称
  DAILY_FILENAME_PREFIX: "投资组合记录-", // 每日文件前缀

  // --- 月度收益日历配置 ---
  MONTHLY_SUMMARY_START_CELL: "J1",    // 月度总结表格起始位置

  // --- 股价更新配置 ---
  TICKER_COLUMN: 2,                    // 股票代码所在列（B列=2）
  PRICE_COLUMN: 4,                     // 现价所在列（D列=4）

  // --- 核心数据单元格配置 ---
  TREND_CHART_CELL_TO_FETCH: "H21",    // 资产总和单元格
  COST_BASIS_CELL_TO_FETCH: "I21",     // 成本总和单元格

  // --- 历史趋势图配置 ---
  TREND_CHART_DATA_SHEET_NAME: "资产图表-源数据",
  TREND_CHART_DISPLAY_SHEET_NAME: "Sheet1",
  TREND_CHART_POSITION_CELL: "N1",     // 图表显示位置
  CHART_WIDTH: 480,                    // 图表宽度
  CHART_HEIGHT: 320,                   // 图表高度

  // --- 等待和重试配置 ---
  MAX_RETRIES_FOR_FORMULA: 5,          // 公式计算最大重试次数
  RETRY_INTERVAL_MS: 3000              // 重试间隔（毫秒）
};
```

---

## 使用方法

### 菜单使用

安装完成后，刷新 Google Sheets 页面，菜单栏会出现：

**📈 投资组合自动化**
- **【一键执行】每日更新全流程** - 执行完整的每日更新流程

### 日常使用流程

1. **每个交易日结束后**（如下午 3:30 后）
2. 打开 Google Sheets 中的模板文件
3. 点击 `📈 投资组合自动化` → `【一键执行】每日更新全流程`
4. 等待脚本执行完成
5. 检查新生成的 `投资组合记录-YYYYMMDD` 文件

### 查看历史数据

- **历史趋势图**：在每日文件的 Sheet1 中查看
- **月度收益日历**：在每日文件的 J1 位置查看
- **原始趋势数据**：在隐藏的 `资产图表-源数据` 工作表中

---

## 自动化设置

### 设置每日自动触发

你可以配置脚本每天自动运行：

1. 在 Apps Script 编辑器中，点击左侧的 ⏰ **触发器** 图标
2. 点击右下角的 **+ 添加触发器**
3. 配置以下选项：
   - **要运行的函数**：`runDailyPortfolioUpdate`
   - **事件源**：时间驱动
   - **时间触发器类型**：日定时器
   - **时间段**：下午 6:00 - 7:00（建议收盘后）
4. 点击 **保存**

### 注意事项

- 触发器可能有几分钟的时间误差
- 确保账号有权限访问所有相关文件
- 建议设置在收盘后 1-2 小时

---

## 常见问题

### Q: 菜单没有显示怎么办？
**A**: 刷新页面，如果仍未显示，检查 Apps Script 代码是否正确保存。或者在 Apps Script 中手动运行 `onOpen` 函数。

### Q: 提示权限错误？
**A**: 重新运行脚本，按照授权步骤重新授权。确保选择正确的 Google 账号。

### Q: 股价没有更新成功？
**A**: 
- 检查股票代码格式是否正确（如 `SHA:600519`）
- 新浪接口可能有访问限制，稍后再试
- Google Finance 可能需要 VPN 访问

### Q: 如何处理休市日？
**A**: 脚本会自动检测休市（资产无变化），并删除当日文件，无需手动处理。

### Q: 如何修改时区？
**A**: 在 Apps Script 中，点击 ⚙️ **项目设置**，修改 **时区** 设置为你所在的时区。

### Q: 文件夹 ID 怎么获取？
**A**: 
1. 打开目标文件夹
2. 查看浏览器地址栏
3. URL 格式：`https://drive.google.com/drive/folders/XXXXXX`
4. `XXXXXX` 部分即为文件夹 ID

### Q: 可以追踪基金吗？
**A**: 暂时只支持通过新浪和 Google Finance 获取价格的标的。基金追踪需要额外配置数据源。

---

## 需要帮助？

如果您在使用过程中遇到问题：
1. 📖 查看 [GitHub Issues](../../issues) 是否有类似问题
2. 🐛 提交新的 Issue 描述您的问题
3. 💬 欢迎贡献改进建议！

---

*最后更新：2025年*
